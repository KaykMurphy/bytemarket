<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ByteMarket - E-commerce de Produtos Digitais</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

    <style>
        :root {
            --primary: #ff8c42;
            --secondary: #6366f1;
            --dark-bg: #0a0a0a;
            --card-bg: #1a1a1a;
            --border: #2a2a2a;
            --text: #e5e5e5;
        }

        body {
            background: var(--dark-bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        .navbar {
            background: rgba(10, 10, 10, 0.98) !important;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            padding: 1rem 0;
        }

        .navbar-brand {
            font-weight: 800;
            font-size: 1.4rem;
            color: var(--primary) !important;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #ff6b35);
            border: none;
            padding: 0.6rem 1.5rem;
            font-weight: 600;
            border-radius: 8px;
        }

        .btn-support {
            background: #9333ea;
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            font-weight: 600;
        }

        .btn-cart {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            position: relative;
        }

        .cart-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .hero {
            background: linear-gradient(135deg, rgba(255, 140, 66, 0.1), rgba(99, 102, 241, 0.1));
            border-radius: 20px;
            padding: 4rem 2rem;
            margin: 2rem 0;
            text-align: center;
        }

        .hero h1 {
            font-size: 3rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .hero-stats {
            display: flex;
            justify-content: center;
            gap: 3rem;
            margin-top: 2rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary);
        }

        .search-input {
            width: 100%;
            padding: 1rem 3rem 1rem 1.5rem;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 50px;
            color: var(--text);
        }

        .search-icon {
            position: absolute;
            right: 1.5rem;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 15px;
            margin-top: 0.5rem;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .search-results.active {
            display: block;
        }

        .search-result-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.3s;
        }

        .search-result-item:hover {
            background: rgba(255, 140, 66, 0.1);
        }

        .search-result-img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 1rem;
        }

        .categories {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            padding: 1rem 0;
            margin-bottom: 2rem;
        }

        .category-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 1.5rem 2rem;
            min-width: 180px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .category-card:hover, .category-card.active {
            border-color: var(--primary);
            transform: translateY(-5px);
        }

        .category-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }

        .product-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 15px;
            overflow: hidden;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }

        .product-card:hover {
            transform: translateY(-10px);
            border-color: var(--primary);
        }

        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .product-body {
            padding: 1.5rem;
        }

        .product-price {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
        }

        .product-stock {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .product-stock.out {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .out-of-stock-badge {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(239, 68, 68, 0.95);
            padding: 0.8rem 2rem;
            border-radius: 10px;
            font-weight: 800;
            z-index: 10;
        }

        .modal-content {
            background: var(--card-bg);
            color: var(--text);
        }

        .product-description {
            background: rgba(255, 140, 66, 0.05);
            padding: 1.5rem;
            border-radius: 10px;
            border-left: 4px solid var(--primary);
        }

        .form-control, .form-select {
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text);
        }

        .form-control:focus, .form-select:focus {
            background: var(--card-bg);
            border-color: var(--primary);
            color: var(--text);
        }

        .ql-toolbar {
            background: var(--border);
            border: 1px solid var(--border) !important;
            border-radius: 10px 10px 0 0;
        }

        .ql-container {
            background: var(--card-bg);
            border: 1px solid var(--border) !important;
            border-radius: 0 0 10px 10px;
            min-height: 200px;
        }

        .ql-editor {
            color: var(--text);
        }

        .screen {
            display: none;
            animation: fadeIn 0.3s;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .not-found-section {
            background: var(--card-bg);
            border: 2px dashed var(--border);
            border-radius: 15px;
            padding: 3rem;
            text-align: center;
            margin: 3rem 0;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-waiting {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
        }

        .status-paid {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .status-cancelled {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .status-delivered {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark sticky-top">
    <div class="container">
        <a class="navbar-brand" href="#" onclick="showScreen('home')">
            <i class="bi bi-controller me-2"></i>ByteMarket
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto align-items-center gap-2">
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showScreen('home')">In√≠cio</a>
                </li>

                <li class="nav-item" id="loginNavBtn">
                    <a class="nav-link" href="#" onclick="showScreen('login')">Entrar</a>
                </li>

                <li class="nav-item d-none" id="myOrdersNavBtn">
                    <a class="nav-link" href="#" onclick="showScreen('myOrders')">Meus Pedidos</a>
                </li>

                <li class="nav-item dropdown d-none" id="adminNavMenu">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">Admin</a>
                    <ul class="dropdown-menu dropdown-menu-dark">
                        <li><a class="dropdown-item" href="#" onclick="showScreen('adminProducts')">Produtos</a></li>
                        <li><a class="dropdown-item" href="#" onclick="showScreen('adminStock')">Estoque</a></li>
                        <li><a class="dropdown-item" href="#" onclick="showScreen('adminSettings')">Configura√ß√µes</a></li>
                    </ul>
                </li>

                <li class="nav-item d-none" id="userNavInfo">
                    <span class="nav-link"><span id="navUserName"></span></span>
                </li>

                <li class="nav-item d-none" id="logoutNavBtn">
                    <a class="nav-link" href="#" onclick="logout()">Sair</a>
                </li>

                <li class="nav-item">
                    <button class="btn-support" onclick="openSupport()">
                        <i class="bi bi-headset me-2"></i>Suporte
                    </button>
                </li>

                <li class="nav-item">
                    <button class="btn-cart" onclick="showScreen('cart')">
                        <i class="bi bi-cart3 me-2"></i>Carrinho
                        <span class="cart-count" id="cartCount">0</span>
                    </button>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container py-4">

    <!-- HOME SCREEN -->
    <div id="homeScreen" class="screen active">
        <div class="hero">
            <h1><i class="bi bi-controller me-3"></i>Seja Bem-vindo(a) na ByteMarket</h1>
            <p>Aqui voc√™ encontra tudo para deixar sua experi√™ncia de jogo ainda melhor. Compra r√°pida, segura e 100% digital. Explore e aproveite!</p>

            <div class="hero-stats">
                <div>
                    <div class="stat-value">4.9/5</div>
                    <div style="color: #999;">AVALIA√á√ïES</div>
                </div>
                <div>
                    <div class="stat-value">R√°pido</div>
                    <div style="color: #999;">ENTREGA AUTOM√ÅTICA</div>
                </div>
                <div>
                    <div class="stat-value">100%</div>
                    <div style="color: #999;">COMPRA SEGURA</div>
                </div>
            </div>
        </div>

        <div style="max-width: 600px; margin: 2rem auto; position: relative;">
            <div style="position: relative;">
                <input type="text" class="search-input" id="searchInput" placeholder="Buscar jogos, streaming, assinaturas, utilidades..." oninput="handleSearch()">
                <i class="bi bi-search search-icon"></i>
            </div>
            <div class="search-results" id="searchResults"></div>
        </div>

        <div class="categories" id="categoriesContainer"></div>

        <div class="product-grid" id="productGrid"></div>

        <div class="not-found-section">
            <h3><i class="bi bi-emoji-frown me-2"></i>N√£o encontrou o que queria?</h3>
            <p>Ou o produto est√° fora de estoque? N√£o se preocupe!</p>
            <button class="btn btn-primary btn-lg" onclick="showScreen('customRequest')">
                <i class="bi bi-chat-dots me-2"></i>Fazer Pedido Personalizado
            </button>
        </div>
    </div>

    <!-- PRODUCT MODAL -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header" style="border-bottom: 1px solid var(--border);">
                    <h5 id="modalProductTitle"></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <img id="modalProductImage" src="" style="width: 100%; border-radius: 15px;" alt="">
                        </div>
                        <div class="col-md-6">
                            <div class="product-price mb-3" id="modalProductPrice"></div>
                            <span class="product-stock" id="modalProductStock"></span>

                            <div class="product-description mt-3" id="modalProductDescription"></div>

                            <div class="my-3">
                                <label class="form-label">Quantidade:</label>
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <button class="btn btn-outline-primary" onclick="changeModalQuantity(-1)">-</button>
                                    <input type="number" class="form-control text-center" style="width: 80px;" id="modalQuantity" value="1" min="1" readonly>
                                    <button class="btn btn-outline-primary" onclick="changeModalQuantity(1)">+</button>
                                </div>
                            </div>

                            <button class="btn btn-primary w-100 mb-2" onclick="addToCart()">
                                <i class="bi bi-cart-plus me-2"></i>Adicionar ao Carrinho
                            </button>

                            <button class="btn btn-outline-primary w-100" onclick="buyNowModal()">
                                <i class="bi bi-lightning me-2"></i>Comprar Agora
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CART SCREEN -->
    <div id="cartScreen" class="screen">
        <h3 class="mb-4"><i class="bi bi-cart3 me-2"></i>Meu Carrinho</h3>
        <div id="cartItems"></div>
        <div class="text-end mt-4">
            <h4>Total: <span id="cartTotal" style="color: var(--primary);">R$ 0,00</span></h4>
            <button class="btn btn-primary btn-lg mt-3" onclick="proceedToCheckout()">Finalizar Pedido</button>
        </div>
    </div>

    <!-- CHECKOUT SCREEN -->
    <div id="checkoutScreen" class="screen">
        <h3 class="mb-4">Finalizar Compra</h3>
        <div style="background: var(--card-bg); padding: 2rem; border-radius: 15px;">
            <div class="mb-3">
                <label class="form-label">Email (para receber o produto)</label>
                <input type="email" class="form-control" id="checkoutEmail">
            </div>
            <div class="mb-3">
                <label class="form-label">Produtos no Pedido:</label>
                <div id="checkoutItems" class="mb-3" style="background: rgba(255,140,66,0.1); padding: 1rem; border-radius: 10px;"></div>
                <div class="d-flex justify-content-between">
                    <span>Total:</span>
                    <strong id="checkoutTotal" style="color: var(--primary);">R$ 0,00</strong>
                </div>
            </div>
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="termsCheck">
                <label class="form-check-label">Eu aceito os termos e condi√ß√µes</label>
            </div>
            <button class="btn btn-success btn-lg w-100" onclick="createOrder()">Confirmar e Pagar</button>
        </div>
    </div>

    <!-- PIX PAYMENT SCREEN -->
    <div id="pixPaymentScreen" class="screen">
        <div style="max-width: 600px; margin: 0 auto; background: var(--card-bg); padding: 2rem; border-radius: 15px; text-align: center;">
            <h3 class="mb-4"><i class="bi bi-qr-code me-2"></i>Pagamento via PIX</h3>

            <div id="paymentInfo" style="background: rgba(59, 130, 246, 0.1); padding: 1.5rem; border-radius: 15px; margin-bottom: 2rem; text-align: left;">
                <h5 id="paymentProductName" class="mb-2">Seu Pedido</h5>
                <div id="paymentItems" class="mb-3"></div>
                <div class="d-flex justify-content-between">
                    <span>Valor Total:</span>
                    <strong id="paymentAmount" style="color: var(--primary); font-size: 1.2rem;">R$ 0,00</strong>
                </div>
            </div>

            <div id="paymentStatus" style="padding: 1rem; background: rgba(234, 179, 8, 0.2); border-radius: 10px; margin-bottom: 2rem;">
                <i class="bi bi-clock me-2"></i>Aguardando pagamento...
            </div>

            <div style="background: white; padding: 2rem; border-radius: 15px; display: inline-block; margin-bottom: 2rem;">
                <img id="pixQrCodeImg" src="" style="max-width: 300px;" alt="QR Code PIX">
            </div>

            <div class="input-group mb-3">
                <input type="text" class="form-control" id="pixCodeInput" readonly>
                <button class="btn btn-primary" onclick="copyPixCode()">
                    <i class="bi bi-clipboard me-2"></i>Copiar C√≥digo
                </button>
            </div>

            <div style="background: rgba(239, 68, 68, 0.1); padding: 1rem; border-radius: 10px; margin-bottom: 2rem;">
                <p style="margin: 0; color: #ef4444;">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong id="pixExpiresAt"></strong>
                </p>
            </div>

            <div class="alert alert-info" role="alert" style="background: rgba(59, 130, 246, 0.1); border: none;">
                <i class="bi bi-info-circle me-2"></i>
                Ap√≥s o pagamento, o sistema atualizar√° automaticamente em alguns segundos.
            </div>
        </div>
    </div>

    <!-- MY ORDERS SCREEN -->
    <div id="myOrdersScreen" class="screen">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="bi bi-receipt me-2"></i>Meus Pedidos</h3>
            <button class="btn btn-primary" onclick="loadMyOrders()">
                <i class="bi bi-arrow-clockwise me-2"></i>Atualizar
            </button>
        </div>

        <div id="ordersList" class="row">
            <!-- Pedidos ser√£o carregados aqui -->
        </div>

        <div id="noOrdersMessage" class="not-found-section d-none">
            <h4><i class="bi bi-emoji-frown me-2"></i>Nenhum pedido encontrado</h4>
            <p>Voc√™ ainda n√£o fez nenhum pedido.</p>
            <button class="btn btn-primary" onclick="showScreen('home')">
                <i class="bi bi-cart me-2"></i>Ir √†s compras
            </button>
        </div>
    </div>

    <!-- CUSTOM REQUEST SCREEN -->
    <div id="customRequestScreen" class="screen">
        <div style="max-width: 600px; margin: 0 auto; background: var(--card-bg); padding: 2rem; border-radius: 15px;">
            <h3 class="mb-4">Pedido Personalizado</h3>
            <form onsubmit="submitCustomRequest(event)">
                <div class="mb-3">
                    <label class="form-label">Seu Nome</label>
                    <input type="text" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Seu Email</label>
                    <input type="email" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">O que voc√™ est√° procurando?</label>
                    <textarea class="form-control" rows="5" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary w-100">Enviar Pedido</button>
            </form>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="screen">
        <div style="max-width: 400px; margin: 0 auto; background: var(--card-bg); padding: 2rem; border-radius: 15px;">
            <h3 class="text-center mb-4">Login</h3>
            <div id="loginError" class="alert alert-danger d-none"></div>
            <form onsubmit="handleLogin(event)">
                <div class="mb-3">
                    <label>Email</label>
                    <input type="email" class="form-control" id="loginEmail" required>
                </div>
                <div class="mb-3">
                    <label>Senha</label>
                    <input type="password" class="form-control" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Entrar</button>
            </form>
            <p class="text-center mt-3">N√£o tem conta? <a href="#" onclick="showScreen('register')" style="color: var(--primary)">Registre-se</a></p>
        </div>
    </div>

    <!-- ADMIN PRODUCTS SCREEN -->
    <div id="adminProductsScreen" class="screen">
        <div class="d-flex justify-content-between mb-4">
            <h3>Gerenciar Produtos</h3>
            <button class="btn btn-primary" onclick="showProductForm()">Novo Produto</button>
        </div>
        <div class="table-responsive">
            <table class="table table-dark">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>T√≠tulo</th>
                    <th>Categoria</th>
                    <th>Pre√ßo</th>
                    <th>Estoque</th>
                    <th>A√ß√µes</th>
                </tr>
                </thead>
                <tbody id="adminProductsTable"></tbody>
            </table>
        </div>
    </div>

    <!-- ADMIN PRODUCT FORM SCREEN -->
    <div id="adminProductFormScreen" class="screen">
        <div style="max-width: 900px; margin: 0 auto; background: var(--card-bg); padding: 2rem; border-radius: 15px;">
            <h3 class="mb-4" id="productFormTitle">Novo Produto</h3>
            <form onsubmit="saveProduct(event)">
                <input type="hidden" id="editProductId">
                <div class="row">
                    <div class="col-md-8 mb-3">
                        <label>T√≠tulo</label>
                        <input type="text" class="form-control" id="productTitle" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label>Categoria</label>
                        <select class="form-select" id="productCategory" required>
                            <option value="">Selecione...</option>
                            <option value="ASSINATURAS">Assinaturas Premium</option>
                            <option value="KEYS">Keys Steam</option>
                            <option value="DISCORD">Discord</option>
                            <option value="CONTAS">Contas/Jogos</option>
                            <option value="UTILIDADES">Utilidades</option>
                            <option value="METODOS">M√©todos</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Pre√ßo (R$)</label>
                        <input type="number" class="form-control" id="productPrice" step="0.01" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>URL da Imagem</label>
                        <input type="url" class="form-control" id="productImage" required>
                    </div>
                </div>
                <div class="mb-3">
                    <label>Descri√ß√£o (Rich Text)</label>
                    <div id="descriptionEditor"></div>
                </div>
                <button type="submit" class="btn btn-primary w-100">Salvar Produto</button>
            </form>
        </div>
    </div>

    <!-- ADMIN STOCK SCREEN -->
    <div id="adminStockScreen" class="screen">
        <div style="max-width: 600px; margin: 0 auto; background: var(--card-bg); padding: 2rem; border-radius: 15px;">
            <h3 class="mb-4">Adicionar Estoque</h3>
            <form onsubmit="addStock(event)">
                <div class="mb-3">
                    <label>Produto</label>
                    <select class="form-select" id="stockProductId" required></select>
                </div>
                <div class="mb-3">
                    <label>Itens (um por linha)</label>
                    <textarea class="form-control" id="stockItems" rows="10" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary w-100">Adicionar ao Estoque</button>
            </form>
        </div>
    </div>

    <!-- ADMIN SETTINGS SCREEN -->
    <div id="adminSettingsScreen" class="screen">
        <div style="max-width: 600px; margin: 0 auto; background: var(--card-bg); padding: 2rem; border-radius: 15px;">
            <h3 class="mb-4">Configura√ß√µes</h3>
            <form onsubmit="saveSettings(event)">
                <div class="mb-3">
                    <label>Link do Discord (Suporte)</label>
                    <input type="url" class="form-control" id="discordLink" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Salvar Configura√ß√µes</button>
            </form>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
    let currentUser = null;
    let authToken = localStorage.getItem('authToken');
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
    let allProducts = [];
    let currentProduct = null;
    let quillEditor = null;
    let paymentPolling = null;
    let discordSupportLink = localStorage.getItem('discordLink') || 'https://discord.gg/seuservidor';
    let currentOrder = null; // Armazena o pedido atual

    document.addEventListener('DOMContentLoaded', () => {
        checkAuth();
        loadProducts();
        updateCartUI();
    });

    async function checkAuth() {
        if (authToken) {
            try {
                // 1. Decodifica o token para pegar a Role e o Email imediatamente
                const payload = JSON.parse(atob(authToken.split('.')[1]));

                // Objeto tempor√°rio para a UI n√£o piscar
                currentUser = {
                    email: payload.sub,
                    role: payload.role
                };

                // 2. Busca o ID real no backend
                const response = await fetch('/auth/me', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const userData = await response.json();
                    // userData traz { id: "uuid-real...", name: "...", email: "..." }

                    // Atualiza o currentUser com o ID real
                    currentUser = { ...currentUser, ...userData };

                    // Atualiza UI
                    updateAuthUI();
                } else {
                    // Se o token for inv√°lido no backend
                    logout();
                }
            } catch (e) {
                console.error("Erro na autentica√ß√£o:", e);
                logout();
            }
        }
    }

    function updateAuthUI() {
        if (currentUser) {
            document.getElementById('loginNavBtn').classList.add('d-none');
            document.getElementById('myOrdersNavBtn').classList.remove('d-none');
            document.getElementById('userNavInfo').classList.remove('d-none');
            document.getElementById('logoutNavBtn').classList.remove('d-none');
            document.getElementById('navUserName').textContent = currentUser.email.split('@')[0];

            if (currentUser.role === 'ADMIN') {
                document.getElementById('adminNavMenu').classList.remove('d-none');
            }
        }
    }

    async function handleLogin(e) {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;

        try {
            const response = await fetch('/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });

            if (response.ok) {
                const data = await response.json();
                authToken = data.token;
                localStorage.setItem('authToken', authToken);
                await checkAuth(); // Aguarda a verifica√ß√£o completa
                showScreen('home');
            } else {
                alert('Email ou senha inv√°lidos');
            }
        } catch (error) {
            alert('Erro ao fazer login');
        }
    }

    function logout() {
        authToken = null;
        currentUser = null;
        currentOrder = null;
        localStorage.removeItem('authToken');
        location.reload();
    }

    async function loadProducts() {
        try {
            const response = await fetch('/products');
            const data = await response.json();
            allProducts = data.content;

            renderProducts(allProducts);
            renderCategories();
        } catch (error) {
            console.error('Erro ao carregar produtos:', error);
        }
    }

    function renderProducts(products) {
        const grid = document.getElementById('productGrid');
        grid.innerHTML = '';

        products.forEach(product => {
            const isOutOfStock = product.availableStock === 0;

            grid.innerHTML += `
            <div class="product-card" onclick="viewProduct(${product.id})">
                ${isOutOfStock ? '<div class="out-of-stock-badge">ESGOTADO</div>' : ''}
                <img src="${product.imageUrl}" class="product-image" alt="${product.title}">
                <div class="product-body">
                    <h5 style="font-size: 1.1rem; font-weight: 700;">${product.title}</h5>
                    <div class="product-price">R$ ${product.price.toFixed(2)}</div>
                    <span class="product-stock${isOutOfStock ? ' out' : ''}">
                        ${isOutOfStock ? 'Esgotado' : product.availableStock + ' em estoque'}
                    </span>
                </div>
            </div>
        `;
        });
    }

    function renderCategories() {
        const categoryMap = {};
        allProducts.forEach(p => {
            if (!categoryMap[p.type]) categoryMap[p.type] = 0;
            categoryMap[p.type]++;
        });

        const icons = {
            'ASSINATURAS': 'üì∫',
            'KEYS': 'üéÆ',
            'DISCORD': 'üí¨',
            'CONTAS': 'üë§',
            'UTILIDADES': 'üîß',
            'METODOS': 'üéØ'
        };

        const container = document.getElementById('categoriesContainer');
        container.innerHTML = `
        <div class="category-card active" onclick="filterByCategory('all')">
            <div class="category-icon">üéÆ</div>
            <div class="category-name">Todos</div>
        </div>
    `;

        Object.keys(categoryMap).forEach(cat => {
            container.innerHTML += `
            <div class="category-card" onclick="filterByCategory('${cat}')">
                <div class="category-icon">${icons[cat] || 'üì¶'}</div>
                <div class="category-name">${cat}</div>
            </div>
        `;
        });
    }

    function filterByCategory(category) {
        document.querySelectorAll('.category-card').forEach(el => el.classList.remove('active'));
        event.target.closest('.category-card').classList.add('active');

        if (category === 'all') {
            renderProducts(allProducts);
        } else {
            const filtered = allProducts.filter(p => p.type === category);
            renderProducts(filtered);
        }
    }

    function handleSearch() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const resultsContainer = document.getElementById('searchResults');

        if (!query) {
            resultsContainer.classList.remove('active');
            return;
        }

        const filtered = allProducts.filter(p =>
            p.title.toLowerCase().includes(query) ||
            p.description.toLowerCase().includes(query)
        );

        if (filtered.length === 0) {
            resultsContainer.innerHTML = '<div style="padding: 1rem; text-align: center; color: #999;">Nenhum produto encontrado</div>';
            resultsContainer.classList.add('active');
            return;
        }

        resultsContainer.innerHTML = '';
        filtered.slice(0, 5).forEach(product => {
            resultsContainer.innerHTML += `
            <div class="search-result-item" onclick="viewProduct(${product.id}); document.getElementById('searchResults').classList.remove('active');">
                <img src="${product.imageUrl}" class="search-result-img" alt="${product.title}">
                <div style="flex: 1;">
                    <h6 style="margin: 0;">${product.title}</h6>
                    <div style="color: var(--primary); font-weight: 700;">R$ ${product.price.toFixed(2)}</div>
                    <div style="font-size: 0.85rem; color: #999;">${product.availableStock} em estoque</div>
                </div>
            </div>
        `;
        });

        resultsContainer.classList.add('active');
    }

    async function viewProduct(id) {
        try {
            const response = await fetch(`/products/${id}`);
            currentProduct = await response.json();

            document.getElementById('modalProductTitle').textContent = currentProduct.title;
            document.getElementById('modalProductImage').src = currentProduct.imageUrl;
            document.getElementById('modalProductPrice').textContent = `R$ ${currentProduct.price.toFixed(2)}`;
            document.getElementById('modalProductStock').textContent = `${currentProduct.availableStock} dispon√≠veis`;
            document.getElementById('modalProductStock').className = currentProduct.availableStock > 0 ? 'product-stock' : 'product-stock out';
            document.getElementById('modalProductDescription').innerHTML = currentProduct.description;
            document.getElementById('modalQuantity').value = 1;
            document.getElementById('modalQuantity').max = currentProduct.availableStock;

            new bootstrap.Modal(document.getElementById('productModal')).show();
        } catch (error) {
            console.error('Erro ao carregar produto:', error);
        }
    }

    function changeModalQuantity(change) {
        const input = document.getElementById('modalQuantity');
        const newValue = parseInt(input.value) + change;
        if (newValue >= 1 && newValue <= currentProduct.availableStock) {
            input.value = newValue;
        }
    }

    function addToCart() {
        if (!currentProduct) return;

        const quantity = parseInt(document.getElementById('modalQuantity').value);
        const existingIndex = cart.findIndex(item => item.id === currentProduct.id);

        if (existingIndex >= 0) {
            cart[existingIndex].quantity += quantity;
        } else {
            cart.push({
                id: currentProduct.id,
                title: currentProduct.title,
                price: currentProduct.price,
                image: currentProduct.imageUrl,
                quantity: quantity,
                maxStock: currentProduct.availableStock
            });
        }

        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartUI();

        bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
        alert('Produto adicionado ao carrinho!');
    }

    function buyNowModal() {
        addToCart();
        showScreen('cart');
    }

    function updateCartUI() {
        const count = cart.reduce((sum, item) => sum + item.quantity, 0);
        document.getElementById('cartCount').textContent = count;

        if (document.getElementById('cartScreen').classList.contains('active')) {
            renderCart();
        }
    }

    function renderCart() {
        const container = document.getElementById('cartItems');

        if (cart.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #999;">Seu carrinho est√° vazio</p>';
            document.getElementById('cartTotal').textContent = 'R$ 0,00';
            return;
        }

        container.innerHTML = '';
        let total = 0;

        cart.forEach((item, index) => {
            const itemTotal = item.price * item.quantity;
            total += itemTotal;

            container.innerHTML += `
            <div style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 10px; padding: 1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 1rem;">
                <img src="${item.image}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 10px;" alt="${item.title}">
                <div style="flex: 1;">
                    <h6>${item.title}</h6>
                    <div style="color: #999;">R$ ${item.price.toFixed(2)} cada</div>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <button class="btn btn-sm btn-outline-primary" onclick="updateCartQuantity(${index}, -1)">-</button>
                    <span>${item.quantity}</span>
                    <button class="btn btn-sm btn-outline-primary" onclick="updateCartQuantity(${index}, 1)">+</button>
                </div>
                <div style="text-align: right;">
                    <div style="font-weight: 700;">R$ ${itemTotal.toFixed(2)}</div>
                    <button class="btn btn-sm btn-outline-danger mt-2" onclick="removeFromCart(${index})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `;
        });

        document.getElementById('cartTotal').textContent = `R$ ${total.toFixed(2)}`;
    }

    function updateCartQuantity(index, change) {
        const item = cart[index];
        const newQuantity = item.quantity + change;

        if (newQuantity >= 1 && newQuantity <= item.maxStock) {
            cart[index].quantity = newQuantity;
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartUI();
        }
    }

    function removeFromCart(index) {
        cart.splice(index, 1);
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartUI();
    }

    function proceedToCheckout() {
        if (!authToken) {
            alert('Fa√ßa login para continuar');
            showScreen('login');
            return;
        }

        if (cart.length === 0) {
            alert('Seu carrinho est√° vazio');
            return;
        }

        // Atualiza informa√ß√µes do checkout
        const checkoutItems = document.getElementById('checkoutItems');
        checkoutItems.innerHTML = '';

        let total = 0;
        cart.forEach(item => {
            const itemTotal = item.price * item.quantity;
            total += itemTotal;

            checkoutItems.innerHTML += `
                <div class="d-flex justify-content-between mb-2">
                    <span>${item.title} (x${item.quantity})</span>
                    <span>R$ ${itemTotal.toFixed(2)}</span>
                </div>
            `;
        });

        document.getElementById('checkoutTotal').textContent = `R$ ${total.toFixed(2)}`;

        showScreen('checkout');
        if (currentUser) {
            document.getElementById('checkoutEmail').value = currentUser.email;
        }
    }

    async function createOrder() {
        const email = document.getElementById('checkoutEmail').value;
        const termsCheck = document.getElementById('termsCheck').checked;

        if (!email) {
            alert('Preencha o email');
            return;
        }

        if (!termsCheck) {
            alert('Aceite os termos e condi√ß√µes');
            return;
        }

        try {
            // Calcula o total do carrinho
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            // Cria o pedido
            const orderData = {
                userId: currentUser?.id || null,
                deliveryEmail: email,
                items: cart.map(item => ({
                    productId: item.id,
                    quantity: item.quantity,
                    unitPrice: item.price
                })),
                totalAmount: total
            };

            console.log('Enviando dados do pedido:', orderData);

            const response = await fetch('/orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify(orderData)
            });

            if (response.ok) {
                const order = await response.json();
                console.log('Pedido criado:', order);
                currentOrder = order; // Salva o pedido atual

                // Gera o pagamento PIX
                const paymentResponse = await fetch(`/payments/pix/orders/${order.id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (paymentResponse.ok) {
                    const payment = await paymentResponse.json();
                    console.log('Pagamento gerado:', payment);

                    // Limpa o carrinho
                    cart = [];
                    localStorage.setItem('cart', JSON.stringify(cart));
                    updateCartUI();

                    // Mostra a tela de pagamento PIX com os dados do pedido e pagamento
                    showPixPayment(payment, order);
                } else {
                    const errorText = await paymentResponse.text();
                    console.error('Erro na resposta do pagamento:', errorText);
                    try {
                        const error = JSON.parse(errorText);
                        alert('Erro ao gerar pagamento: ' + (error.message || 'Erro desconhecido'));
                    } catch {
                        alert('Erro ao gerar pagamento: ' + errorText);
                    }
                }
            } else {
                const errorText = await response.text();
                console.error('Erro na resposta do pedido:', errorText);
                try {
                    const error = JSON.parse(errorText);
                    alert('Erro ao criar pedido: ' + (error.message || 'Erro desconhecido'));
                } catch {
                    alert('Erro ao criar pedido: ' + errorText);
                }
            }
        } catch (error) {
            console.error('Erro no processo:', error);
            alert('Erro ao processar pedido. Verifique sua conex√£o e tente novamente.');
        }
    }

    function showPixPayment(payment, order) {
        // Preenche informa√ß√µes do produto usando os dados do pedido
        const paymentItemsContainer = document.getElementById('paymentItems');
        paymentItemsContainer.innerHTML = '';

        if (order.items && order.items.length > 0) {
            order.items.forEach(item => {
                const itemTotal = item.unitPrice * item.quantity;
                paymentItemsContainer.innerHTML += `
                    <div class="d-flex justify-content-between mb-1">
                        <span>${item.product?.title || 'Produto'} (x${item.quantity})</span>
                        <span>R$ ${itemTotal.toFixed(2)}</span>
                    </div>
                `;
            });
        } else {
            paymentItemsContainer.innerHTML = '<div class="text-muted">Carregando informa√ß√µes dos produtos...</div>';
        }

        // Formata o valor a partir do pagamento (n√£o do carrinho)
        document.getElementById('paymentAmount').textContent = `R$ ${payment.amount.toFixed(2)}`;

        // Configura QR Code
        if (payment.pixQrCode) {
            const qrCodeSrc = payment.pixQrCode.startsWith('data:image')
                ? payment.pixQrCode
                : `data:image/png;base64,${payment.pixQrCode}`;
            document.getElementById('pixQrCodeImg').src = qrCodeSrc;
        }

        // Configura c√≥digo PIX
        if (payment.pixQrCodeText) {
            document.getElementById('pixCodeInput').value = payment.pixQrCodeText;
        }

        // Configura data de expira√ß√£o
        if (payment.expiresAt) {
            const expiresAt = new Date(payment.expiresAt);
            const now = new Date();
            const diffMinutes = Math.round((expiresAt - now) / (1000 * 60));

            if (diffMinutes > 0) {
                document.getElementById('pixExpiresAt').textContent =
                    `Expira em ${diffMinutes} minutos (${expiresAt.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})})`;
            } else {
                document.getElementById('pixExpiresAt').textContent = 'Expira em breve!';
            }
        }

        showScreen('pixPayment');

        // Inicia verifica√ß√£o do pagamento
        if (payment.paymentId) {
            startPaymentPolling(payment.paymentId, order.id);
        }
    }

    function startPaymentPolling(paymentId, orderId) {
        if (paymentPolling) clearInterval(paymentPolling);

        paymentPolling = setInterval(async () => {
            try {
                const response = await fetch(`/payments/${paymentId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const payment = await response.json();

                    if (payment.status === 'APPROVED' || payment.status === 'CONFIRMED') {
                        clearInterval(paymentPolling);

                        document.getElementById('paymentStatus').style.background = 'rgba(16, 185, 129, 0.2)';
                        document.getElementById('paymentStatus').style.color = '#10b981';
                        document.getElementById('paymentStatus').innerHTML = '<i class="bi bi-check-circle me-2"></i>Pagamento Aprovado!';

                        setTimeout(() => {
                            alert('Pagamento confirmado! Os produtos ser√£o enviados para o seu email.');
                            showScreen('myOrders'); // Redireciona para a tela de pedidos
                        }, 3000);
                    } else if (payment.status === 'EXPIRED' || payment.status === 'CANCELLED') {
                        clearInterval(paymentPolling);

                        document.getElementById('paymentStatus').style.background = 'rgba(239, 68, 68, 0.2)';
                        document.getElementById('paymentStatus').style.color = '#ef4444';
                        document.getElementById('paymentStatus').innerHTML = '<i class="bi bi-x-circle me-2"></i>Pagamento Expirado ou Cancelado';

                        setTimeout(() => {
                            alert('Pagamento n√£o realizado. Tente novamente.');
                            showScreen('cart');
                        }, 3000);
                    }
                }
            } catch (error) {
                console.error('Erro ao verificar pagamento:', error);
            }
        }, 5000); // Verifica a cada 5 segundos
    }

    async function loadMyOrders() {
        if (!currentUser || !authToken) {
            alert('Fa√ßa login para ver seus pedidos');
            showScreen('login');
            return;
        }

        try {
            const response = await fetch(`/users/${currentUser.id}/orders`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });

            if (response.ok) {
                const orders = await response.json();
                renderMyOrders(orders);
            } else if (response.status === 404) {
                // Usu√°rio n√£o tem pedidos ainda
                renderMyOrders([]);
            } else {
                throw new Error('Erro ao carregar pedidos');
            }
        } catch (error) {
            console.error('Erro ao carregar pedidos:', error);
            document.getElementById('noOrdersMessage').classList.remove('d-none');
            document.getElementById('ordersList').innerHTML = '';
        }
    }

    function renderMyOrders(orders) {
        const ordersList = document.getElementById('ordersList');
        const noOrdersMessage = document.getElementById('noOrdersMessage');

        if (!orders || orders.length === 0) {
            ordersList.innerHTML = '';
            noOrdersMessage.classList.remove('d-none');
            return;
        }

        noOrdersMessage.classList.add('d-none');
        ordersList.innerHTML = '';

        // Ordena pedidos por data (mais recente primeiro)
        orders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

        orders.forEach(order => {
            const orderDate = new Date(order.createdAt);
            const formattedDate = orderDate.toLocaleDateString('pt-BR');
            const formattedTime = orderDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

            // Mapeia status para classes CSS e textos
            const statusConfig = {
                'WAITING_PAYMENT': { class: 'status-waiting', text: 'Aguardando Pagamento' },
                'PAID': { class: 'status-paid', text: 'Pago' },
                'CANCELLED': { class: 'status-cancelled', text: 'Cancelado' },
                'EXPIRED': { class: 'status-cancelled', text: 'Expirado' },
                'DELIVERED': { class: 'status-delivered', text: 'Entregue' }
            };

            const statusInfo = statusConfig[order.status] || { class: 'status-waiting', text: order.status };

            // Cria o card do pedido
            const orderCard = document.createElement('div');
            orderCard.className = 'col-md-6 mb-4';
            orderCard.innerHTML = `
                <div class="card h-100" style="background: var(--card-bg); border: 1px solid var(--border);">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h5 class="card-title">Pedido #${order.id.substring(0, 8)}</h5>
                                <p class="card-text text-muted mb-1">
                                    <small>
                                        <i class="bi bi-calendar me-1"></i>${formattedDate} √†s ${formattedTime}
                                    </small>
                                </p>
                            </div>
                            <span class="status-badge ${statusInfo.class}">${statusInfo.text}</span>
                        </div>

                        <div class="mb-3">
                            <h6 class="mb-2">Produtos:</h6>
                            <div style="max-height: 150px; overflow-y: auto;">
                                ${order.items.map(item => `
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>${item.product?.title || 'Produto'} (x${item.quantity})</span>
                                        <span>R$ ${(item.unitPrice * item.quantity).toFixed(2)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Total:</strong>
                                <h4 class="d-inline-block ms-2" style="color: var(--primary);">R$ ${order.totalAmount.toFixed(2)}</h4>
                            </div>
                            <div>
                                ${order.status === 'WAITING_PAYMENT'
                ? `<button class="btn btn-sm btn-primary" onclick="viewOrderPayment('${order.id}')">
                                        <i class="bi bi-qr-code me-1"></i>Ver PIX
                                       </button>`
                : `<button class="btn btn-sm btn-outline-primary" onclick="viewOrderItems('${order.id}')">
                                        <i class="bi bi-list me-1"></i>Ver Detalhes
                                       </button>`
            }
                            </div>
                        </div>
                    </div>
                </div>
            `;

            ordersList.appendChild(orderCard);
        });
    }

    async function viewOrderPayment(orderId) {
        try {
            // Busca o pagamento do pedido
            const response = await fetch(`/payments/order/${orderId}`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });

            if (response.ok) {
                const payment = await response.json();

                // Busca os detalhes do pedido
                const orderResponse = await fetch(`/orders/${orderId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (orderResponse.ok) {
                    const order = await orderResponse.json();
                    showPixPayment(payment, order);
                } else {
                    alert('N√£o foi poss√≠vel carregar os detalhes do pedido');
                }
            } else {
                alert('N√£o foi poss√≠vel carregar o pagamento deste pedido');
            }
        } catch (error) {
            console.error('Erro ao carregar pagamento:', error);
            alert('Erro ao carregar pagamento do pedido');
        }
    }

    async function viewOrderItems(orderId) {
        try {
            const response = await fetch(`/orders/${orderId}`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });

            if (response.ok) {
                const order = await response.json();

                let itemsHtml = '<div style="max-height: 300px; overflow-y: auto;">';
                order.items.forEach(item => {
                    itemsHtml += `
                        <div class="mb-3 p-3" style="background: rgba(255,140,66,0.05); border-radius: 10px;">
                            <div class="d-flex justify-content-between">
                                <h6>${item.product?.title || 'Produto'}</h6>
                                <span>R$ ${(item.unitPrice * item.quantity).toFixed(2)}</span>
                            </div>
                            <div class="d-flex justify-content-between text-muted">
                                <span>Quantidade: ${item.quantity}</span>
                                <span>Unit√°rio: R$ ${item.unitPrice.toFixed(2)}</span>
                            </div>
                        </div>
                    `;
                });
                itemsHtml += '</div>';

                alert({
                    title: `Detalhes do Pedido #${orderId.substring(0, 8)}`,
                    content: itemsHtml,
                    type: 'info'
                });
            } else {
                alert('N√£o foi poss√≠vel carregar os detalhes do pedido');
            }
        } catch (error) {
            console.error('Erro ao carregar pedido:', error);
            alert('Erro ao carregar detalhes do pedido');
        }
    }

    function copyPixCode() {
        const input = document.getElementById('pixCodeInput');
        input.select();
        input.setSelectionRange(0, 99999); // Para mobile

        navigator.clipboard.writeText(input.value)
            .then(() => {
                alert('C√≥digo PIX copiado! Cole no seu aplicativo banc√°rio.');
            })
            .catch(err => {
                console.error('Erro ao copiar: ', err);
                alert('N√£o foi poss√≠vel copiar. Selecione e copie manualmente.');
            });
    }

    function submitCustomRequest(e) {
        e.preventDefault();
        alert('Pedido enviado! Entraremos em contato em breve.');
        showScreen('home');
    }

    function openSupport() {
        window.open(discordSupportLink, '_blank');
    }

    async function loadAdminProducts() {
        try {
            const response = await fetch('/products', {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            const data = await response.json();

            const tbody = document.getElementById('adminProductsTable');
            tbody.innerHTML = '';

            data.content.forEach(product => {
                tbody.innerHTML += `
                <tr>
                    <td>${product.id}</td>
                    <td>${product.title}</td>
                    <td>${product.type}</td>
                    <td>R$ ${product.price.toFixed(2)}</td>
                    <td>${product.availableStock}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editProduct(${product.id})">Editar</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteProduct(${product.id})">Excluir</button>
                    </td>
                </tr>
            `;
            });
        } catch (error) {
            console.error('Erro:', error);
        }
    }

    function showProductForm(productId = null) {
        if (productId) {
            document.getElementById('productFormTitle').textContent = 'Editar Produto';
            loadProductForEdit(productId);
        } else {
            document.getElementById('productFormTitle').textContent = 'Novo Produto';
            document.getElementById('editProductId').value = '';
            document.getElementById('productTitle').value = '';
            document.getElementById('productCategory').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productImage').value = '';

            if (quillEditor) {
                quillEditor.root.innerHTML = '';
            }
        }

        showScreen('adminProductForm');

        if (!quillEditor) {
            quillEditor = new Quill('#descriptionEditor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['clean']
                    ]
                }
            });
        }
    }

    async function loadProductForEdit(id) {
        try {
            const response = await fetch(`/products/${id}`);
            const product = await response.json();

            document.getElementById('editProductId').value = product.id;
            document.getElementById('productTitle').value = product.title;
            document.getElementById('productCategory').value = product.type;
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productImage').value = product.imageUrl;

            if (quillEditor) {
                quillEditor.root.innerHTML = product.description;
            }
        } catch (error) {
            console.error('Erro:', error);
        }
    }

    async function saveProduct(e) {
        e.preventDefault();

        const id = document.getElementById('editProductId').value;
        const data = {
            title: document.getElementById('productTitle').value,
            description: quillEditor.root.innerHTML,
            price: parseFloat(document.getElementById('productPrice').value),
            type: document.getElementById('productCategory').value,
            imageUrl: document.getElementById('productImage').value
        };

        try {
            const url = id ? `/admin/products/${id}` : '/admin/products';
            const method = id ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                alert('Produto salvo!');
                showScreen('adminProducts');
                loadAdminProducts();
                loadProducts();
            } else {
                alert('Erro ao salvar produto');
            }
        } catch (error) {
            console.error('Erro:', error);
        }
    }

    async function deleteProduct(id) {
        if (!confirm('Deseja excluir este produto?')) return;

        try {
            const response = await fetch(`/admin/products/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${authToken}` }
            });

            if (response.ok) {
                alert('Produto exclu√≠do!');
                loadAdminProducts();
                loadProducts();
            }
        } catch (error) {
            console.error('Erro:', error);
        }
    }

    function editProduct(id) {
        showProductForm(id);
    }

    async function loadStockProducts() {
        try {
            const response = await fetch('/products');
            const data = await response.json();

            const select = document.getElementById('stockProductId');
            select.innerHTML = '<option value="">Selecione...</option>';

            data.content.forEach(product => {
                select.innerHTML += `
                <option value="${product.id}">${product.title} (${product.availableStock} em estoque)</option>
            `;
            });
        } catch (error) {
            console.error('Erro:', error);
        }
    }

    async function addStock(e) {
        e.preventDefault();

        const productId = document.getElementById('stockProductId').value;
        const itemsText = document.getElementById('stockItems').value;

        const items = itemsText.split('\n')
            .filter(line => line.trim())
            .map(line => ({ content: line.trim() }));

        try {
            const response = await fetch(`/admin/products/${productId}/stock`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify(items)
            });

            if (response.ok) {
                alert(`${items.length} itens adicionados!`);
                document.getElementById('stockItems').value = '';
                loadProducts();
            } else {
                alert('Erro ao adicionar estoque');
            }
        } catch (error) {
            console.error('Erro:', error);
        }
    }

    function saveSettings(e) {
        e.preventDefault();
        const link = document.getElementById('discordLink').value;
        localStorage.setItem('discordLink', link);
        discordSupportLink = link;
        alert('Configura√ß√µes salvas!');
    }

    function showScreen(screenName) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));

        const screens = {
            'home': 'homeScreen',
            'cart': 'cartScreen',
            'checkout': 'checkoutScreen',
            'pixPayment': 'pixPaymentScreen',
            'customRequest': 'customRequestScreen',
            'login': 'loginScreen',
            'adminProducts': 'adminProductsScreen',
            'adminProductForm': 'adminProductFormScreen',
            'adminStock': 'adminStockScreen',
            'adminSettings': 'adminSettingsScreen',
            'myOrders': 'myOrdersScreen'
        };

        const screenId = screens[screenName];
        if (screenId) {
            document.getElementById(screenId).classList.add('active');

            if (screenName === 'cart') renderCart();
            if (screenName === 'adminProducts') loadAdminProducts();
            if (screenName === 'adminStock') loadStockProducts();
            if (screenName === 'adminSettings') {
                document.getElementById('discordLink').value = discordSupportLink;
            }
            if (screenName === 'myOrders') {
                loadMyOrders();
            }
        }

        window.scrollTo(0, 0);
    }

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.search-input') && !e.target.closest('.search-results')) {
            document.getElementById('searchResults').classList.remove('active');
        }
    });
</script>

</body>
</html>